name: Sync opened issues to Height

on:
  issues:
    types: [opened, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  create_height_subtask:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Cache jq
        uses: actions/cache@v2
        with:
          path: /usr/local/bin/jq
          key: jq-{{ hashFiles('jq-version') }}
      - name: Setup jq
        run: sudo apt-get install -y jq
      - name: Encode the payload as JSON
        run: |
          export encoded_issue_body=$(echo "${{ github.event.issue.body }}" | jq -cR 'gsub("\n"; "\\n")')
          export payload=$(echo '{
            "name": "${{ github.event.issue.title }}",
            "description": "$encoded_issue_body",
            "listIds": [
              "0540b3b8-bd44-4904-a97f-fd9d8780ef0a"
            ],
            "parentTaskId": "2dded224-8da0-4407-868f-d9cd018cbe52",
            "status": "a347dcd0-d492-4e7b-86e6-5e7b759134d8",
            "orderIntent": {
              "intent": "end"
            },
            "assigneesIds": [
              "848a5626-451f-4e15-b711-bd0a84883718",
              "fe99c0a6-ad7b-458d-ae9f-687af57e0053",
              "b0093618-6032-4e90-aa01-1dfc6628832d"
            ],
            "links": [],
            "fields": [
              {
                "fieldTemplateId": "f1bae626-c18c-4198-b354-560d1610766c",
                "name": "Tags",
                "type": "labels",
                "value": null,
                "label": null,
                "values": null,
                "date": null,
                "recursion": null,
                "labels": [
                  {
                    "id": "a7ba7d3e-d1d6-4111-92e6-e89c9456ea13",
                    "model": "fieldLabel",
                    "value": "github-issue",
                    "date": null,
                    "hue": 49,
                    "deleted": false,
                    "archived": false
                  }
                ],
                "linkedTasks": null,
                "linkedTimer": null,
                "selectValue": null
              }
            ]
          }')
          echo $payload > payload.json
      - name: Log payload
        run: cat payload.json
      - name: Lint payload as valid JSON
        run: npx jsonlint payload.json
      - name: Create a new subtask with issue details in Height
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://api.height.app/tasks'
          method: 'POST'
          customHeaders: '{ "Content-Type": "application/json", "Authorization": "api-key ${{ secrets.HEIGHT_SECRET_TOKEN }}" }'
          data: ${{ cat payload.json }}
          timeout: 15000
      - name: Check API response
        if: steps.create_subtask.outputs.status != 200
        run: exit 1
